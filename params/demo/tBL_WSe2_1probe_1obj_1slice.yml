# tBL_WSe2

exp_params : {
    'kv'                : 80,  # kV
    'conv_angle'        : 24.9, # mrad, semi-convergence angle
    'Npix'              : 128, # Detector pixel number, EMPAD is 128. Only supports square detector for simplicity
    'dx_spec'           : 0.1494, # Ang
    'defocus'           : 0, # Ang, positive defocus here refers to actual underfocus or weaker lens strength following Kirkland/abtem/ptychoshelves convention
    'c3'                : 0, # Ang, spherical aberration coefficients
    'z_distance'        : 12, # Ang
    'Nlayer'            : 1,
    'N_scans'           : 16384,
    'N_scan_slow'       : 128,
    'N_scan_fast'       : 128,
    'scan_step_size'    : 0.4290, # Ang
    'scan_flipT'        : null, # null for both 'simu' and loaded pos. Modify scan_flipT would change the image orientation. Expected input is [flipup, fliplr, transpose] just like PtychoShleves
    'scan_affine'       : null, # (scale, asymmetry, rotation, shear)
    'scan_rand_std'     : 0.15, # null or scalar. Randomize the initial guess of scan position with Gaussian distributed displacement (std in px) to avoid raster grid pathology
    'omode_max'         : 1,
    'omode_init_occu'   : {'occu_type': 'uniform', 'init_occu': null},
    'pmode_max'         : 1,
    'pmode_init_pows'   : [0.02],
    'probe_permute'     : null,
    'meas_permute'           : null,
    'meas_reshape'           : null,
    'meas_flipT'             : [1,0,0], # Expected input is [flipup, fliplr, transpose] just like PtychoShleves
    'meas_crop'              : null, # null or (4,2) array-like for [[scan_slow_start, scan_slow_end], [scan_fast_start, scan_fast_end], [ky_start, ky_end], [kx_start, kx_end]]
    'meas_resample'          : null, # null or (2,1) array-like for [ky_zoom, kx_zoom]
    'meas_add_source_size'   : null, # null or a scalar of std (Ang)
    'meas_add_detector_blur' : null, # null or a scalar of std (px)
    'meas_add_poisson_noise' : null, # null or a scalar of electrons/Ang^2
    'probe_simu_params'      : null
}

# Source and params, note that these should be changed in accordance with each other
source_params : {
    'measurements_source': 'hdf5',
    'measurements_params': {'path': 'data/tBL_WSe2/Fig_1h_24.9mrad_Themis/1/data_roi1_Ndp128_step128_dp.hdf5', 'key':'dp'},
    'obj_source'         : 'simu',
    'obj_params'         : null,
    'probe_source'       : 'simu',
    'probe_params'       : null,  
    'pos_source'         : 'simu',
    'pos_params'         : null,
    'tilt_source'        : 'simu',
    'tilt_params'        : {'tilt_type':'all', 'init_tilts':[[0,0]]}, # 'init_tilts' = (tilt_y,tilt_x) mrad, 'tilt_type' = 'all', 'each' 
}

hypertune_params : {
    'if_hypertune'   : false,
    'collate_results': true, # null or a list of stings
    'collate_figs'   : true, # null or a list of stings
    'n_trials'       : 1000,
    'use_pruning'    : true,
    'storage_path'   : 'sqlite:///20240829_hypertune.sqlite3',
    'study_name'     : 'tBL_WSe2',
    'tune_params'    : { # Hypertune optimizable parameters, these will override the corresponding values in `exp_params``
        'conv_angle' : {'state': false, 'min': 24, 'max': 26, 'step': 0.1},
        'defocus'    : {'state': false, 'min': -50, 'max': 50, 'step': 10},
        'z_distance' : {'state': true, 'min': 1.5, 'max': 2.5, 'step': 0.5},
        'scale'      : {'state': false, 'min': 0.9, 'max': 1.1, 'step': 0.05},
        'asymmetry'  : {'state': false, 'min': -0.2, 'max': 0.2, 'step': 0.05},
        'rotation'   : {'state': false, 'min': -4, 'max': 4, 'step': 0.5},
        'shear'      : {'state': false, 'min': -4, 'max': 4, 'step': 0.5},
        'tilt_y'     : {'state': false, 'min': -5, 'max': 5, 'step': 0.5}, # This refers to the `init_tilts` under `source_params['tilt_params']['init_tilts']`
        'tilt_x'     : {'state': false, 'min': -5, 'max': 5, 'step': 0.5}  # This refers to the `init_tilts` under `source_params['tilt_params']['init_tilts']`
    }
}

model_params : {
    'obj_preblur_std'     : null, # scalar(px), null
    'detector_blur_std'   : null, # scalar(px), null
    'lr_params':{
        'obja'            : 5.0e-4,
        'objp'            : 5.0e-4,
        'obj_tilts'       : 0, 
        'probe'           : 1.0e-4, 
        'probe_pos_shifts': 5.0e-4}}

loss_params : {
    'loss_single': {'state': true, 'weight': 1.0, 'dp_pow': 0.5},
    'loss_poissn': {'state': false, 'weight': 1.0, 'dp_pow': 1.0, 'eps': 1.0e-6},
    'loss_pacbed': {'state': false, 'weight': 0.5, 'dp_pow': 0.2}, # Usually weight:0.5, dp_pow:0.2
    'loss_sparse': {'state': true, 'weight': 0.1, 'ln_order': 1},
    'loss_simlar': {'state': false, 'weight': 0.1, 'obj_type': 'both', 'scale_factor': [1,1,1], 'blur_std': 1}
}

constraint_params : {
    'ortho_pmode'   : {'freq': null},
    'probe_mask_k'  : {'freq': null, 'radius': 0.22, 'width': 0.05}, # k-radius should be larger than 2*rbf/Npix to avoid cutting out the BF disk
    'fix_probe_int' : {'freq': 1},
    'obj_rblur'     : {'freq': null, 'obj_type': 'both', 'kernel_size': 5, 'std': 0.2}, # Ideally kernel size is odd and larger than 6std+1 so it decays to 0
    'obj_zblur'     : {'freq': null, 'obj_type': 'both', 'kernel_size': 5, 'std': 1},
    'kr_filter'     : {'freq': null, 'obj_type': 'both', 'radius': 0.15, 'width': 0.05},
    'kz_filter'     : {'freq': null, 'obj_type': 'both', 'beta': 0.1, 'alpha': 1},
    'obja_thresh'   : {'freq': null, 'relax': 0, 'thresh': [0.98, 1.02]},
    'objp_postiv'   : {'freq': 1,    'relax': 0},
    'tilt_smooth'   : {'freq': null, 'std': 2}
}

recon_params: {
  'NITER': 10,
  'INDICES_MODE': {'mode': 'full', 'subscan_slow': null, 'subscan_fast': null},  # 'full', 'center', 'sub'
  'BATCH_SIZE': 32,
  'GROUP_MODE': 'random',  # 'random', 'sparse', 'compact' # Note that 'sparse' for 256x256 scan could take more than 10 mins on CPU. PtychoShelves automatically switch to 'random' for Nscans>1e3
  'SAVE_ITERS': 10,  # scalar or null
  'output_dir': 'output/tBL-WSe2_demo/',  # Output folder and pre/postfix, note that the needed / and _ are automatically generated
  'dir_affixes': ['lr', 'constraint', 'model', 'loss'], # 'lr', 'constraint', 'model', 'loss', 'init'
  'prefix_date': true,
  'prefix': '',
  'postfix': '',
  'save_result': ['model', 'obj', 'probe'],
  'result_modes': {'FOV': ['full'], 'bit': {32, 16, 8}},
  'fig_list': ['loss', 'forward', 'probe_r_amp', 'probe_k_amp', 'probe_k_phase', 'pos'],  # 'loss', 'forward', 'probe_r_amp', 'probe_k_amp', 'probe_k_phase', 'pos', 'tilt', or 'all' for all the figures
  'copy_params': true,
  'if_quiet': false
}